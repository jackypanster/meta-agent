---
description:
globs:
alwaysApply: false
---
---
description: Enforce fail-fast principle - immediate failure over fallback mechanisms
globs: src/**/*.py, tests/**/*.py, **/*.py
alwaysApply: true
---

# âš¡ Fail-Fast Design Principle

## **æ ¸å¿ƒåŸåˆ™ï¼šç«‹å³å¤±è´¥ä¼˜äºæ©ç›–é—®é¢˜**

- **NEVER use fallback mechanisms to hide ANY problems or exceptions**
- **ALWAYS let ALL exceptions bubble up immediately for fast problem identification**
- **NEVER write long, smelly code with multiple fallbacks for ANY error scenarios**
- **ANY exception should cause immediate program termination, not silent fallback**

## **æ‰€æœ‰å¼‚å¸¸å¤„ç†è§„åˆ™**

### **âœ… DO: ä»»ä½•å¼‚å¸¸éƒ½ç«‹å³å¤±è´¥**

```python
# âœ… GOOD: é…ç½®ç¼ºå¤±æ—¶ç«‹å³å¤±è´¥
def get_config_value(key: str) -> str:
    try:
        return config.require(key)
    except ConfigError as e:
        raise RuntimeError(f"âŒ é…ç½®é”™è¯¯ '{key}': {str(e)}") from e

# âœ… GOOD: APIè°ƒç”¨å¤±è´¥æ—¶ç«‹å³æŠ›å‡º
def call_api(endpoint: str) -> dict:
    response = requests.get(endpoint)
    if not response.ok:
        raise APIError(f"APIè°ƒç”¨å¤±è´¥: {response.status_code}")
    return response.json()

# âœ… GOOD: æ–‡ä»¶æ“ä½œå¤±è´¥æ—¶ç«‹å³å¤±è´¥
def load_required_file(path: str) -> str:
    # ä¸è¦æ•è·FileNotFoundErrorï¼Œè®©å®ƒç›´æ¥æŠ›å‡º
    with open(path) as f:
        return f.read()

# âœ… GOOD: æ•°æ®åº“æ“ä½œå¤±è´¥æ—¶ç«‹å³å¤±è´¥
def get_user(user_id: int) -> User:
    # ä¸è¦æ•è·æ•°æ®åº“å¼‚å¸¸ï¼Œè®©å®ƒç›´æ¥æŠ›å‡º
    return db.session.query(User).filter(User.id == user_id).one()

# âœ… GOOD: JSONè§£æå¤±è´¥æ—¶ç«‹å³å¤±è´¥
def parse_json_data(data: str) -> dict:
    # ä¸è¦æ•è·JSONDecodeErrorï¼Œè®©å®ƒç›´æ¥æŠ›å‡º
    return json.loads(data)

# âœ… GOOD: ç½‘ç»œè¯·æ±‚å¤±è´¥æ—¶ç«‹å³å¤±è´¥
def fetch_data(url: str) -> dict:
    # ä¸è¦æ•è·requestså¼‚å¸¸ï¼Œè®©å®ƒç›´æ¥æŠ›å‡º
    response = requests.get(url, timeout=10)
    response.raise_for_status()  # ç«‹å³æŠ›å‡ºHTTPé”™è¯¯
    return response.json()
```

### **âŒ DON'T: ä½¿ç”¨fallbackæ©ç›–ä»»ä½•é—®é¢˜**

```python
# âŒ BAD: fallbackæ©ç›–é…ç½®é—®é¢˜
def get_config_with_fallback(key: str, fallback: str = "") -> str:
    try:
        return config.get(key)
    except Exception:
        print(f"âš ï¸ é…ç½®ç¼ºå¤±ï¼Œä½¿ç”¨é»˜è®¤å€¼: {fallback}")
        return fallback  # æ©ç›–äº†çœŸæ­£çš„é—®é¢˜ï¼

# âŒ BAD: é™é»˜å¤„ç†APIé”™è¯¯
def call_api_with_fallback(endpoint: str) -> dict:
    try:
        response = requests.get(endpoint)
        return response.json()
    except Exception as e:
        print(f"APIè°ƒç”¨å¤±è´¥ï¼Œè¿”å›ç©ºå­—å…¸: {e}")
        return {}  # æ©ç›–äº†ç½‘ç»œæˆ–APIé—®é¢˜ï¼

# âŒ BAD: é™é»˜å¤„ç†æ–‡ä»¶è¯»å–é”™è¯¯
def load_file_with_fallback(path: str) -> str:
    try:
        with open(path) as f:
            return f.read()
    except Exception as e:
        print(f"æ–‡ä»¶è¯»å–å¤±è´¥ï¼Œè¿”å›ç©ºå­—ç¬¦ä¸²: {e}")
        return ""  # æ©ç›–äº†æ–‡ä»¶ä¸å­˜åœ¨æˆ–æƒé™é—®é¢˜ï¼

# âŒ BAD: é™é»˜å¤„ç†æ•°æ®åº“é”™è¯¯
def get_user_with_fallback(user_id: int) -> Optional[User]:
    try:
        return db.session.query(User).filter(User.id == user_id).one()
    except Exception as e:
        print(f"æ•°æ®åº“æŸ¥è¯¢å¤±è´¥ï¼Œè¿”å›None: {e}")
        return None  # æ©ç›–äº†æ•°æ®åº“è¿æ¥æˆ–æŸ¥è¯¢é—®é¢˜ï¼

# âŒ BAD: é™é»˜å¤„ç†JSONè§£æé”™è¯¯
def parse_json_with_fallback(data: str) -> dict:
    try:
        return json.loads(data)
    except Exception as e:
        print(f"JSONè§£æå¤±è´¥ï¼Œè¿”å›ç©ºå­—å…¸: {e}")
        return {}  # æ©ç›–äº†æ•°æ®æ ¼å¼é—®é¢˜ï¼

# âŒ BAD: å¤šå±‚fallbackå¯¼è‡´ä»£ç å†—é•¿
def complex_fallback_mess(key: str) -> str:
    try:
        return primary_source.get(key)
    except Exception:
        try:
            return secondary_source.get(key)
        except Exception:
            try:
                return tertiary_source.get(key)
            except Exception:
                return "default_value"  # è°çŸ¥é“å“ªé‡Œå‡ºäº†é—®é¢˜ï¼Ÿ
```

## **å¼‚å¸¸å¤„ç†æœ€ä½³å®è·µ**

### **ç«‹å³å¤±è´¥çš„å¼‚å¸¸ç­–ç•¥**

- âœ… **DO**: è®©æ‰€æœ‰å¼‚å¸¸å¿«é€Ÿä¼ æ’­åˆ°è°ƒç”¨è€…
- âœ… **DO**: æä¾›æ¸…æ™°çš„é”™è¯¯ä¿¡æ¯æŒ‡å‘é—®é¢˜æ ¹æº
- âœ… **DO**: ä½¿ç”¨å…·ä½“çš„å¼‚å¸¸ç±»å‹
- âœ… **DO**: è®©ç¨‹åºåœ¨é‡åˆ°ä»»ä½•å¼‚å¸¸æ—¶ç«‹å³ç»ˆæ­¢
- âŒ **DON'T**: æ•è·ä»»ä½•å¼‚å¸¸åè¿”å›é»˜è®¤å€¼
- âŒ **DON'T**: ä½¿ç”¨bare except: æ•è·æ‰€æœ‰å¼‚å¸¸
- âŒ **DON'T**: æ‰“å°è­¦å‘Šåç»§ç»­æ‰§è¡Œ
- âŒ **DON'T**: ä½¿ç”¨try-exceptåŒ…è£…ä»»ä½•å¯èƒ½å¤±è´¥çš„æ“ä½œ
- âŒ **DON'T**: è®¤ä¸º"ç¨‹åºä¸åº”è¯¥å´©æºƒ"è€Œæ·»åŠ å¼‚å¸¸å¤„ç†

```python
# âœ… GOOD: å…·ä½“çš„å¼‚å¸¸ç±»å‹å’Œæ¸…æ™°çš„é”™è¯¯ä¿¡æ¯
class ConfigurationError(Exception):
    """é…ç½®ç›¸å…³é”™è¯¯"""
    pass

class APIConnectionError(Exception):
    """APIè¿æ¥é”™è¯¯"""
    pass

class DataProcessingError(Exception):
    """æ•°æ®å¤„ç†é”™è¯¯"""
    pass

def validate_config():
    if not os.path.exists('.env'):
        raise ConfigurationError(
            "âŒ .envæ–‡ä»¶ä¸å­˜åœ¨ï¼\n"
            "è¯·å¤åˆ¶ env.template åˆ° .env å¹¶å¡«å…¥APIå¯†é’¥"
        )

def process_data(data: str):
    # ä¸è¦æ•è·ä»»ä½•å¼‚å¸¸ï¼Œè®©å®ƒä»¬ç›´æ¥æŠ›å‡º
    parsed = json.loads(data)  # å¯èƒ½æŠ›å‡ºJSONDecodeError
    result = complex_calculation(parsed)  # å¯èƒ½æŠ›å‡ºå„ç§å¼‚å¸¸
    return result

# âŒ BAD: ä»»ä½•å½¢å¼çš„å¼‚å¸¸å¤„ç†éƒ½æ˜¯é”™è¯¯çš„
def validate_config_bad():
    try:
        # ä¸€äº›é…ç½®éªŒè¯
        pass
    except Exception as e:
        print(f"é…ç½®æœ‰é—®é¢˜ï¼Œä½†æˆ‘ä»¬ç»§ç»­: {e}")  # æ©ç›–é—®é¢˜ï¼
        return False

def process_data_bad(data: str):
    try:
        return json.loads(data)
    except Exception as e:
        print(f"æ•°æ®å¤„ç†å¤±è´¥: {e}")
        return {}  # ä»»ä½•fallbackéƒ½æ˜¯é”™è¯¯çš„ï¼
```

## **é…ç½®ç®¡ç†è§„åˆ™**

### **é…ç½®åŠ è½½ç­–ç•¥**

- âœ… **DO**: ç¨‹åºå¯åŠ¨æ—¶éªŒè¯æ‰€æœ‰å¿…éœ€é…ç½®
- âœ… **DO**: é…ç½®ç¼ºå¤±æ—¶ç«‹å³å¤±è´¥ï¼Œä¸è¦å¯åŠ¨ç¨‹åº
- âœ… **DO**: æä¾›æ˜ç¡®çš„é…ç½®é”™è¯¯ä¿¡æ¯
- âŒ **DON'T**: ç¨‹åºè¿è¡Œæ—¶æ‰å‘ç°é…ç½®é—®é¢˜
- âŒ **DON'T**: ä½¿ç”¨ç¡¬ç¼–ç çš„é»˜è®¤å€¼ä½œä¸ºfallback

```python
# âœ… GOOD: å¯åŠ¨æ—¶éªŒè¯é…ç½®
def validate_startup_config():
    """ç¨‹åºå¯åŠ¨æ—¶éªŒè¯æ‰€æœ‰å¿…éœ€é…ç½®"""
    required_configs = [
        'DEEPSEEK_API_KEY',
        'DATABASE_URL',
        'SECRET_KEY'
    ]
    
    missing = []
    for key in required_configs:
        try:
            config.require(key)
        except ConfigError:
            missing.append(key)
    
    if missing:
        raise ConfigurationError(
            f"âŒ ç¼ºå°‘å¿…éœ€é…ç½®: {', '.join(missing)}\n"
            f"è¯·åœ¨.envæ–‡ä»¶ä¸­è®¾ç½®è¿™äº›é…ç½®é¡¹"
        )

# âŒ BAD: è¿è¡Œæ—¶æ‰å‘ç°é…ç½®é—®é¢˜
def get_api_key_with_default():
    try:
        return config.get('API_KEY')
    except:
        return "default-key-that-wont-work"  # é—®é¢˜è¢«æ¨è¿Ÿåˆ°APIè°ƒç”¨æ—¶ï¼
```

## **ä»£ç è´¨é‡è§„åˆ™**

### **é¿å…é•¿ä¸”è‡­çš„fallbackä»£ç **

- âœ… **DO**: ä¿æŒå‡½æ•°ç®€çŸ­ï¼Œå•ä¸€èŒè´£
- âœ… **DO**: è®©æ¯ä¸ªå‡½æ•°è¦ä¹ˆæˆåŠŸï¼Œè¦ä¹ˆå¤±è´¥
- âœ… **DO**: ä½¿ç”¨ç±»å‹æç¤ºæ˜ç¡®å‡½æ•°å¥‘çº¦
- âŒ **DON'T**: å†™è¶…è¿‡20è¡Œçš„é”™è¯¯å¤„ç†ä»£ç 
- âŒ **DON'T**: åœ¨ä¸€ä¸ªå‡½æ•°ä¸­å¤„ç†å¤šç§fallbackæƒ…å†µ
- âŒ **DON'T**: ä½¿ç”¨æ·±å±‚åµŒå¥—çš„try-catch

```python
# âœ… GOOD: æ¸…æ™°ç®€æ´çš„å‡½æ•°
def load_prompt(key: str) -> str:
    """åŠ è½½æç¤ºè¯ï¼Œå¤±è´¥æ—¶ç«‹å³æŠ›å‡ºå¼‚å¸¸"""
    return prompt_manager.get_prompt(key)

def send_request(url: str) -> dict:
    """å‘é€HTTPè¯·æ±‚ï¼Œå¤±è´¥æ—¶ç«‹å³æŠ›å‡ºå¼‚å¸¸"""
    response = requests.get(url, timeout=10)
    response.raise_for_status()
    return response.json()

# âŒ BAD: åˆé•¿åˆè‡­çš„fallbackä»£ç 
def load_prompt_with_fallbacks(key: str, category: str = "", locale: str = "zh") -> str:
    try:
        return prompt_manager.get_prompt(key)
    except Exception:
        try:
            return prompt_manager.get_prompt(f"{category}.{key}")
        except Exception:
            try:
                return prompt_manager.get_prompt(f"{locale}.{key}")
            except Exception:
                try:
                    return prompt_manager.get_prompt(f"default.{key}")
                except Exception:
                    try:
                        return hardcoded_prompts.get(key, "")
                    except Exception:
                        return f"Missing prompt: {key}"  # 30è¡Œä»£ç æ©ç›–é—®é¢˜ï¼
```

## **æµ‹è¯•å’Œè°ƒè¯•åŸåˆ™**

### **å¯æµ‹è¯•çš„fail-fastä»£ç **

- âœ… **DO**: ç¼–å†™æµ‹è¯•éªŒè¯å¼‚å¸¸è¢«æ­£ç¡®æŠ›å‡º
- âœ… **DO**: ä½¿ç”¨pytest.raiseséªŒè¯å¼‚å¸¸è¡Œä¸º
- âœ… **DO**: æ¨¡æ‹Ÿé…ç½®ç¼ºå¤±åœºæ™¯è¿›è¡Œæµ‹è¯•
- âŒ **DON'T**: æµ‹è¯•fallbackè¡Œä¸ºï¼Œè€Œåº”è¯¥æµ‹è¯•æ­£ç¡®è¡Œä¸º

```python
# âœ… GOOD: æµ‹è¯•å¼‚å¸¸è¡Œä¸º
def test_config_missing_raises_error():
    with pytest.raises(ConfigurationError, match="âŒ .envæ–‡ä»¶ä¸å­˜åœ¨"):
        validate_config()

def test_api_failure_raises_error():
    with pytest.raises(APIConnectionError):
        call_api("http://invalid-endpoint")

# âŒ BAD: æµ‹è¯•fallbackè¡Œä¸º
def test_config_fallback_returns_default():
    # è¿™ç§æµ‹è¯•é¼“åŠ±äº†é”™è¯¯çš„è®¾è®¡ï¼
    result = get_config_with_fallback("missing_key", "default")
    assert result == "default"
```

## **é”™è¯¯ä¿¡æ¯è§„åˆ™**

### **æä¾›å¯æ“ä½œçš„é”™è¯¯ä¿¡æ¯**

- âœ… **DO**: é”™è¯¯ä¿¡æ¯åŒ…å«å…·ä½“çš„ä¿®å¤æ­¥éª¤
- âœ… **DO**: æŒ‡å‡ºå…·ä½“çš„æ–‡ä»¶è·¯å¾„æˆ–é…ç½®é¡¹
- âœ… **DO**: ä½¿ç”¨emojiå’Œæ ¼å¼åŒ–æé«˜å¯è¯»æ€§
- âŒ **DON'T**: æä¾›æ¨¡ç³Šçš„"something went wrong"ä¿¡æ¯
- âŒ **DON'T**: åªæ˜¾ç¤ºæŠ€æœ¯å¼‚å¸¸ä¿¡æ¯

```python
# âœ… GOOD: å¯æ“ä½œçš„é”™è¯¯ä¿¡æ¯
raise ConfigurationError(
    "âŒ DeepSeek APIå¯†é’¥æœªé…ç½®ï¼\n"
    "è¯·åœ¨.envæ–‡ä»¶ä¸­è®¾ç½®: DEEPSEEK_API_KEY=your-api-key\n"
    "è·å–APIå¯†é’¥: https://platform.deepseek.com/"
)

raise FileNotFoundError(
    "âŒ é…ç½®æ–‡ä»¶ä¸å­˜åœ¨: config/prompts/system_prompts.json\n"
    "è¯·è¿è¡Œ: cp config/prompts/system_prompts.json.template config/prompts/system_prompts.json"
)

# âŒ BAD: æ— ç”¨çš„é”™è¯¯ä¿¡æ¯
raise Exception("Configuration error")  # å®Œå…¨æ²¡æœ‰å¸®åŠ©ï¼
raise ValueError("Invalid value")  # ä»€ä¹ˆå€¼ï¼Ÿå“ªé‡Œæ— æ•ˆï¼Ÿ
```

## **é‡æ„å’Œä»£ç å®¡æŸ¥**

### **è¯†åˆ«éœ€è¦é‡æ„çš„fallbackä»£ç **

å¦‚æœä»£ç ä¸­å‡ºç°ä»¥ä¸‹æ¨¡å¼ï¼Œç«‹å³é‡æ„ï¼š
- ğŸš¨ **ä»»ä½•try-catchç»“æ„ï¼ˆé™¤äº†èµ„æºæ¸…ç†ï¼‰**
- ğŸš¨ **å‡½æ•°ä¸­æœ‰ä»»ä½•"fallback"ã€"default"æˆ–"backup"å˜é‡**
- ğŸš¨ **å‡½æ•°ä¸­æœ‰ä»»ä½•å¼‚å¸¸å¤„ç†é€»è¾‘**
- ğŸš¨ **æ³¨é‡Šä¸­å‡ºç°"å¦‚æœå¤±è´¥å°±..."ã€"å‡ºé”™æ—¶..."çš„é€»è¾‘**
- ğŸš¨ **è¿”å›Optionalç±»å‹æ¥å¤„ç†å¯èƒ½çš„å¤±è´¥**
- ğŸš¨ **ä½¿ç”¨Unionç±»å‹æ¥å¤„ç†æˆåŠŸ/å¤±è´¥æƒ…å†µ**
- ğŸš¨ **ä»»ä½•å½¢å¼çš„"å®¹é”™"æˆ–"å¥å£®æ€§"å¤„ç†**

### **é‡æ„ç­–ç•¥**

1. **ç§»é™¤æ‰€æœ‰try-catch** - è®©å¼‚å¸¸è‡ªç„¶ä¼ æ’­
2. **åˆ é™¤æ‰€æœ‰fallbacké€»è¾‘** - ä¸è¦å¤„ç†ä»»ä½•é”™è¯¯æƒ…å†µ
3. **ç®€åŒ–å‡½æ•°ç­¾å** - ç§»é™¤Optionalå’ŒUnionè¿”å›ç±»å‹
4. **ç§»é™¤æ‰€æœ‰é»˜è®¤å€¼å‚æ•°** - å¼ºåˆ¶è°ƒç”¨è€…æä¾›æ‰€æœ‰å¿…éœ€å‚æ•°
5. **åˆ é™¤æ‰€æœ‰"å®¹é”™"ä»£ç ** - ç¨‹åºåº”è¯¥åœ¨é‡åˆ°é—®é¢˜æ—¶ç«‹å³å´©æºƒ
6. **ç§»é™¤æ‰€æœ‰æ—¥å¿—è®°å½•å¼‚å¸¸çš„ä»£ç ** - å¼‚å¸¸æœ¬èº«å°±æ˜¯æœ€å¥½çš„é”™è¯¯ä¿¡æ¯

## **ç›¸å…³æ–‡æ¡£**

- [å®‰å…¨è§„åˆ™](mdc:.cursor/rules/security.mdc) - APIå¯†é’¥ä¿æŠ¤
- [ä»£ç è§„èŒƒ](mdc:.cursor/rules/cursor_rules.mdc) - ä¸€èˆ¬ä»£ç è§„èŒƒ
- [æµ‹è¯•è§„åˆ™](mdc:.cursor/rules/tests.mdc) - æµ‹è¯•æœ€ä½³å®è·µ

---

## **ğŸš¨ ä¸¥å‰è­¦å‘Š**

**ä»»ä½•è¯•å›¾"è®©ç¨‹åºæ›´å¥å£®"ã€"å¢åŠ å®¹é”™æ€§"ã€"ä¼˜é›…å¤„ç†é”™è¯¯"çš„æƒ³æ³•éƒ½æ˜¯é”™è¯¯çš„ï¼**

- ğŸš« **ç¨‹åºå´©æºƒæ˜¯å¥½äº‹** - å®ƒèƒ½ç«‹å³æš´éœ²é—®é¢˜
- ğŸš« **å¼‚å¸¸å¤„ç†æ˜¯æœ‰å®³çš„** - å®ƒæ©ç›–äº†çœŸæ­£çš„é—®é¢˜
- ğŸš« **é»˜è®¤å€¼æ˜¯å±é™©çš„** - å®ƒè®©ç¨‹åºåœ¨é”™è¯¯çŠ¶æ€ä¸‹ç»§ç»­è¿è¡Œ
- ğŸš« **å®¹é”™æœºåˆ¶æ˜¯é™·é˜±** - å®ƒè®©bugå˜å¾—éš¾ä»¥å‘ç°

**è®°ä½ï¼šä»£ç åº”è¯¥è¦ä¹ˆå·¥ä½œï¼Œè¦ä¹ˆå¿«é€Ÿå¤±è´¥ã€‚æ²¡æœ‰ä¸­é—´åœ°å¸¦ï¼**

**è®©ç¨‹åºå´©æºƒï¼Œè®©é—®é¢˜æš´éœ²ï¼Œè®©å¼€å‘è€…ç«‹å³ä¿®å¤ï¼**
